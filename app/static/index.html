<!DOCTYPE html>
<html>
<head>
    <title>Reverse Voting System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .voting-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .voting-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .vote-btn {
            padding: 40px;
            border: none;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .vote-btn.red {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }
        .vote-btn.green {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
        }
        .vote-btn:hover { transform: scale(1.05); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .vote-btn:active { transform: scale(0.98); }
        .stats {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        .stat-label { font-weight: bold; font-size: 1.1em; }
        .stat-value { font-size: 2em; font-weight: bold; }
        .stat-value.red { color: #ff6b6b; }
        .stat-value.green { color: #51cf66; }
        .progress-bar {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-red { background: #ff6b6b; }
        .progress-green { background: #51cf66; }
        .timer {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }
        .sidebar {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            height: fit-content;
        }
        .sidebar h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .status {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        .status.winner {
            background: #f0fdf4;
            border-left-color: #51cf66;
            font-weight: bold;
            color: #37b24d;
        }
        .history-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .history-section h2 {
            margin-bottom: 30px;
            color: #333;
            font-size: 1.8em;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .history-item.red { border-left-color: #ff6b6b; }
        .history-item.green { border-left-color: #51cf66; }
        .history-winner { font-weight: bold; font-size: 1.1em; color: #333; }
        .history-votes { color: #666; font-size: 0.9em; }
        .history-time { color: #999; font-size: 0.85em; }
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            .voting-buttons { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Reverse Voting</h1>
            <p>Pick Red or Green - The LOSER becomes the winner!</p>
        </div>

        <div class="main-content">
            <div class="voting-section">
                <div class="timer">‚è±Ô∏è Round ends in: <span id="timer">60</span>s</div>
                
                <div class="voting-buttons">
                    <button class="vote-btn red" onclick="vote('red')">üî¥ RED</button>
                    <button class="vote-btn green" onclick="vote('green')">üü¢ GREEN</button>
                </div>

                <div class="stats">
                    <div class="stat-row">
                        <div>
                            <div class="stat-label">üî¥ Red Votes</div>
                            <div class="stat-value red" id="red-count">0</div>
                        </div>
                        <div>
                            <div class="stat-label">üü¢ Green Votes</div>
                            <div class="stat-value green" id="green-count">0</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-red" id="progress-red" style="width: 50%;"></div>
                        <div class="progress-green" id="progress-green" style="width: 50%;"></div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <h2>üìä Status</h2>
                <div id="status-container"></div>
            </div>
        </div>

        <div class="history-section">
            <h2>üìú Voting History</h2>
            <div id="history-container"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let timerInterval = null;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/api/voting/ws`);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateUI(data);
            };
            
            ws.onclose = () => {
                console.log("WebSocket closed, reconnecting...");
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
            };
        }

        function vote(option) {
            fetch('/api/voting/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ option: option })
            })
            .then(response => response.json())
            .then(data => updateUI(data))
            .catch(error => console.error('Error:', error));
        }

        function updateUI(data) {
            const totalVotes = data.red_votes + data.green_votes;
            const redPercent = totalVotes > 0 ? (data.red_votes / totalVotes) * 100 : 50;
            const greenPercent = 100 - redPercent;

            document.getElementById('red-count').textContent = data.red_votes;
            document.getElementById('green-count').textContent = data.green_votes;
            document.getElementById('progress-red').style.width = redPercent + '%';
            document.getElementById('progress-green').style.width = greenPercent + '%';
            document.getElementById('timer').textContent = data.seconds_remaining || 60;
        }

        function loadHistory() {
            fetch('/api/history/')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('history-container');
                    if (data.length === 0) {
                        container.innerHTML = '<p style="text-align:center;color:#999;">No completed rounds yet</p>';
                        return;
                    }
                    container.innerHTML = data.map(round => `
                        <div class="history-item ${round.winner}">
                            <div>
                                <div class="history-winner">üèÜ ${round.winner.toUpperCase()} WON</div>
                                <div class="history-votes">üî¥ Red: ${round.red_votes} | üü¢ Green: ${round.green_votes}</div>
                            </div>
                            <div class="history-time">${new Date(round.created_at).toLocaleString()}</div>
                        </div>
                    `).join('');
                })
                .catch(error => console.error('Error loading history:', error));
        }

        function loadStatus() {
            fetch('/api/voting/status')
                .then(response => response.json())
                .then(data => updateUI(data))
                .catch(error => console.error('Error loading status:', error));
        }

        // Initialize
        connectWebSocket();
        loadStatus();
        loadHistory();
        
        // Refresh history every 5 seconds
        setInterval(loadHistory, 5000);
        // Refresh status every 2 seconds
        setInterval(loadStatus, 2000);
    </script>
</body>
</html>